<!doctype html>
<meta charset="utf-8">
<link href="http://d2v52k3cl9vedd.cloudfront.net/basscss/7.0.4/basscss.min.css" rel="stylesheet">
<title>Speech Loop</title>
<style></style>
<body>
<script>
var qs = (function(a) {
    if (a == "") return {};
    var b = {};
    for (var i = 0; i < a.length; ++i)
    {
        var p=a[i].split('=', 2);
        if (p.length == 1)
            b[p[0]] = "";
        else
            b[p[0]] = decodeURIComponent(p[1].replace(/\+/g, " "));
    }
    return b;
})(window.location.search.substr(1).split('&'));

var respond = function(event) {
	var text = '';

	for (var i = event.resultIndex; i < event.results.length; ++i) {
		var result = event.results[i];

		text += result[0].transcript;

		if (result.isFinal) {
			output.innerHTML = text;
			output.style.color = 'black';
			output = createOutput();
			if (qs['t']==text) { speak("OK"); }
			else { speak("sorry"); }
		} else {
			output.innerHTML = text;
		}
	}
}

var createOutput = function() {
	var output = document.createElement('output');
	output.style.color = 'gray';
	document.body.appendChild(output);

	return output;
}

var speak = function(text) {
	// chrome://flags -> Enable experimental Web Platform features
	var utterance = new SpeechSynthesisUtterance(text);
	utterance.lang = 'en-US';
	utterance.volume = 1; // 0 to 1
	utterance.rate = 1; // 0.1 to 10
	utterance.pitch = 1; //0 to 2
	window.speechSynthesis.speak(utterance);
}

var listen = function() {
	var recognition = new webkitSpeechRecognition();
	recognition.continuous = false;
	recognition.interimResults = true;
	recognition.lang = 'en-US';
	recognition.start();
	recognition.onresult = respond;
	//recognition.onend = function(event) { console.log(event) };
}

var output = createOutput();
listen();
</script>
</body></html>
